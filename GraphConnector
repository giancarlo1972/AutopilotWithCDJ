# 0. Disconnect Graph
Uninstall-Module Microsoft.Graph* -AllVersions -Force
Uninstall-Module Microsoft.Graph.Authentication -Version 2.34.0 -Force

Install-Module Microsoft.Graph -Version 2.33.0 -Force -Scope CurrentUser
Import-Module Microsoft.Graph.Authentication -Force

# 1. Remove everything completely
Get-Module Microsoft.Graph* -ListAvailable | Uninstall-Module -AllVersions -Force -ErrorAction SilentlyContinue
Uninstall-Module Microsoft.Graph -AllVersions -Force -ErrorAction SilentlyContinue

# 2. Install the latest stable 2.x version (as of Jan 2026 this is 2.35+)
Install-Module Microsoft.Graph -MinimumVersion 2.33.0 -Force -Scope CurrentUser -AllowClobber

# 3. Verify the authentication module version
(Get-Module Microsoft.Graph.Authentication -ListAvailable | Sort Version -Descending)[0].Version


Then 

Connect-MgGraph -UseDeviceCode -NoWelcome -Scopes "DeviceManagementServiceConfig.ReadWrite.All","DeviceManagementManagedDevices.ReadWrite.All"



Connect-MgGraph -Scopes "User.Read.All","AuditLog.Read.All" -UseDeviceCode

Install-Module Microsoft.Graph -Scope CurrentUser -Force

Install-Module PowerShellGet -Force

Get-Module Microsoft.Graph -ListAvailable


DEVICE CODE
# Make sure module is installed (any recent 2.x is OK)
Install-Module Microsoft.Graph -Scope CurrentUser -Force

# Connect with device code instead of interactive browser
Connect-MgGraph -Scopes "User.Read.All","AuditLog.Read.All" -UseDeviceCode

